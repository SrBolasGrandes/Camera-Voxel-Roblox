<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Minecraft Fajuto</title>

<style>
    body {
        margin: 0;
        background: #87ceeb;
        overflow: hidden;
    }

    canvas {
        display: block;
        image-rendering: pixelated;
    }

    #hud {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        font-family: monospace;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
    }
</style>
</head>

<body>

<canvas id="game" width="320" height="200"></canvas>
<div id="hud">W/S: andar<br>A/D: girar</div>

<script>
/* ================= CONFIG ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const SEND_FPS = 10;
const SCALE = 4;
/* ========================================= */

/* ================= PLAYER ================= */
let player = {
    x: 0,
    z: 0,
    rot: 0
};

const speed = 0.1;
const rotSpeed = 0.05;
/* ========================================= */

/* ================= INPUT ================= */
const keys = {};

document.addEventListener("keydown", e => {
    keys[e.key.toLowerCase()] = true;
});
document.addEventListener("keyup", e => {
    keys[e.key.toLowerCase()] = false;
});
/* ========================================= */

/* ================= WORLD ================= */
const blocks = [];
for (let x = -5; x <= 5; x++) {
    for (let z = -5; z <= 5; z++) {
        blocks.push({ x, y: 0, z });
    }
}
/* ========================================= */

/* ================= 3D FAKE ================= */
function project(x, y, z) {
    const dx = x - player.x;
    const dz = z - player.z;

    const sin = Math.sin(player.rot);
    const cos = Math.cos(player.rot);

    const rx = dx * cos - dz * sin;
    const rz = dx * sin + dz * cos;

    if (rz <= 0.1) return null;

    const scale = 60 / rz;
    return {
        x: canvas.width / 2 + rx * scale,
        y: canvas.height / 2 - y * scale,
        s: scale
    };
}
/* ========================================= */

/* ================= RENDER ================= */
function drawBlock(b) {
    const p = project(b.x, b.y, b.z);
    if (!p) return;

    const size = p.s * 10;

    ctx.fillStyle = "#55aa33";
    ctx.fillRect(p.x - size / 2, p.y - size / 2, size, size);
}

function render() {
    ctx.fillStyle = "#87ceeb";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#5c913b";
    ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

    blocks.forEach(drawBlock);
}
/* ========================================= */

/* ================= UPDATE ================= */
function update() {
    if (keys["w"]) {
        player.x += Math.sin(player.rot) * speed;
        player.z += Math.cos(player.rot) * speed;
    }
    if (keys["s"]) {
        player.x -= Math.sin(player.rot) * speed;
        player.z -= Math.cos(player.rot) * speed;
    }
    if (keys["a"]) player.rot -= rotSpeed;
    if (keys["d"]) player.rot += rotSpeed;
}
/* ========================================= */

/* ================= STREAM ================= */
function sendFrame() {
    const temp = document.createElement("canvas");
    temp.width = 64;
    temp.height = 64;

    const tctx = temp.getContext("2d");
    tctx.drawImage(canvas, 0, 0, 64, 64);

    const base64 = temp.toDataURL("image/jpeg", 0.6).split(",")[1];

    fetch("/camera", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: base64 })
    });
}
/* ========================================= */

/* ================= LOOP ================= */
let lastSend = 0;

function loop(t) {
    update();
    render();

    if (t - lastSend > 1000 / SEND_FPS) {
        sendFrame();
        lastSend = t;
    }

    requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
/* ========================================= */
</script>

</body>
</html>
