<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Camera Voxel</title>

<style>
body {
  margin:0;
  background:black;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}

#view {
  width:320px;
  height:320px;
  border:2px solid white;
  image-rendering: pixelated;
}

button {
  margin-top:10px;
  padding:8px 16px;
}
</style>
</head>
<body>

<canvas id="view" width="96" height="96"></canvas>
<button id="start">▶ Iniciar câmera</button>
<button id="mode" disabled>Modo: COLOR</button>

<video id="video" playsinline muted style="opacity:0;position:absolute"></video>
<canvas id="send" width="96" height="96" hidden></canvas>

<script>
const video = document.getElementById("video")
const view = document.getElementById("view")
const vctx = view.getContext("2d")
const send = document.getElementById("send")
const sctx = send.getContext("2d")

const startBtn = document.getElementById("start")
const modeBtn = document.getElementById("mode")

let started = false
let mode = "color"

modeBtn.onclick = () => {
  mode = mode === "color" ? "bw" : "color"
  modeBtn.innerText = "Modo: " + mode.toUpperCase()
}

startBtn.onclick = async () => {
  if (started) return
  started = true

  const stream = await navigator.mediaDevices.getUserMedia({ video:true })
  video.srcObject = stream
  await video.play()

  startBtn.style.display = "none"
  modeBtn.disabled = false
}

setInterval(() => {
  if (!started || video.videoWidth === 0) return

  vctx.drawImage(video,0,0,96,96)
  sctx.drawImage(video,0,0,96,96)

  const img = send.toDataURL("image/jpeg",0.5).split(",")[1]

  fetch("/camera",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      image: img,
      mode: mode
    })
  })
},50)
</script>

</body>
</html>
