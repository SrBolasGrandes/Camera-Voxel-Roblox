<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Camera Voxel</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body {
  margin:0;
  background:black;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}

#view {
  width:320px;
  height:320px;
  border:2px solid white;
  image-rendering: pixelated;
}

#video {
  position:absolute;
  opacity:0;
  pointer-events:none;
}

button {
  margin-top:10px;
  padding:8px 16px;
}
</style>
</head>
<body>

<canvas id="view" width="96" height="96"></canvas>
<div id="status">‚è∏Ô∏è C√¢mera parada</div>

<button id="startBtn">‚ñ∂ Iniciar c√¢mera</button>
<button id="modeBtn" disabled>Modo: COLOR</button>

<video id="video" playsinline muted></video>
<canvas id="send" width="96" height="96" hidden></canvas>

<script>
const video = document.getElementById("video")
const view = document.getElementById("view")
const vctx = view.getContext("2d")
const send = document.getElementById("send")
const sctx = send.getContext("2d")
const status = document.getElementById("status")
const startBtn = document.getElementById("startBtn")
const modeBtn = document.getElementById("modeBtn")

let started = false
let smiling = false
let mode = "color"

modeBtn.onclick = () => {
  mode = mode === "color" ? "bw" : "color"
  modeBtn.textContent = "Modo: " + mode.toUpperCase()
}

const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
})

faceMesh.setOptions({ maxNumFaces:1 })

faceMesh.onResults(r => {
  smiling = false
  if (r.multiFaceLandmarks?.[0]) {
    const lm = r.multiFaceLandmarks[0]
    const w = Math.abs(lm[61].x - lm[291].x)
    const o = Math.abs(lm[13].y - lm[14].y)
    if (o > w * 0.25) smiling = true
  }
  status.textContent = smiling ? "üòÑ SORRINDO" : "üòê Sem sorriso"
})

startBtn.onclick = async () => {
  if (started) return
  started = true

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode:"user" },
    audio:false
  })

  video.srcObject = stream

  await video.play()

  video.onloadedmetadata = () => {
    const cam = new Camera(video,{
      onFrame: async () => {
        await faceMesh.send({ image: video })
      }
    })
    cam.start()
  }

  startBtn.style.display = "none"
  modeBtn.disabled = false
}

setInterval(() => {
  if (!started || video.videoWidth === 0) return

  vctx.drawImage(video,0,0,96,96)
  sctx.drawImage(video,0,0,96,96)

  const img = send.toDataURL("image/jpeg",0.5).split(",")[1]

  fetch("/camera",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      image: img,
      smiling: smiling,
      mode: mode
    })
  })
},50)
</script>

</body>
</html>
