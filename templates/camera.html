<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Camera Smile</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body {
  margin:0;
  background:black;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}
video {
  width:420px;
}
button {
  margin-top:10px;
  padding:6px 14px;
}
.smile {
  color:#00ff88;
  font-weight:bold;
}
</style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<div id="status">üòê Sem sorriso</div>
<button id="modeBtn">Modo: COLORIDO</button>

<canvas id="c" width="96" height="96" hidden></canvas>

<script>
const video = document.getElementById("video")
const canvas = document.getElementById("c")
const ctx = canvas.getContext("2d")
const status = document.getElementById("status")
const modeBtn = document.getElementById("modeBtn")

let smiling = false
let mode = "color"

modeBtn.onclick = () => {
  mode = mode === "color" ? "bw" : "color"
  modeBtn.textContent = "Modo: " + (mode === "color" ? "COLORIDO" : "P&B")
}

const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
})

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true
})

faceMesh.onResults(results => {
  smiling = false

  if (results.multiFaceLandmarks?.[0]) {
    const lm = results.multiFaceLandmarks[0]
    const w = Math.abs(lm[61].x - lm[291].x)
    const o = Math.abs(lm[13].y - lm[14].y)
    if (o > w * 0.25) smiling = true
  }

  status.textContent = smiling ? "üòÑ SORRINDO" : "üòê Sem sorriso"
  status.className = smiling ? "smile" : ""
})

navigator.mediaDevices.getUserMedia({ video:true })
.then(stream => {
  video.srcObject = stream
  const cam = new Camera(video, {
    onFrame: async () => {
      await faceMesh.send({ image: video })
    }
  })
  cam.start()
})

setInterval(() => {
  ctx.drawImage(video, 0, 0, 96, 96)
  const img = canvas.toDataURL("image/jpeg", 0.45).split(",")[1]

  fetch("/camera", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      image: img,
      smiling: smiling,
      mode: mode
    })
  })
}, 50)
</script>

</body>
</html>
